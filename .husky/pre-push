#!/usr/bin/env bash
set -euo pipefail

echo "üîé pre-push: TypeScript y Lint‚Ä¶"

# Flags para saltar pasos si hace falta
: "${AIDUX_SKIP_TYPECHECK:=0}"
: "${AIDUX_SKIP_LINT:=0}"

run() { echo "+ $*"; "$@"; }

# pnpm saludable (no solo un shim de Volta)
have_pnpm() {
  command -v pnpm >/dev/null 2>&1 && pnpm --version >/dev/null 2>&1
}

# Listado de scripts declarados en package.json (soporta pnpm o npm)
list_scripts() {
  if have_pnpm; then
    pnpm run 2>/dev/null || true
  else
    npm run 2>/dev/null || true
  fi
}

# ¬øExiste un script dado?
have_script() {
  local s="$1"
  list_scripts | grep -qE "^  ${s}\b"
}

# Ejecuta un script con el gestor disponible
run_script() {
  local s="$1"
  if have_pnpm; then
    run pnpm -s run "$s"
  else
    run npm run --silent "$s"
  fi
}

# TYPECHECK
if [[ "$AIDUX_SKIP_TYPECHECK" != "1" ]]; then
  if have_script typecheck; then
    run_script typecheck
  else
    echo "‚ÑπÔ∏è  No hay script 'typecheck' ‚Üí lo salto"
  fi
else
  echo "‚è≠Ô∏è  Skip typecheck (AIDUX_SKIP_TYPECHECK=1)"
fi

# LINT
if [[ "$AIDUX_SKIP_LINT" != "1" ]]; then
  if have_script lint; then
    run_script lint
  else
    echo "‚ÑπÔ∏è  No hay script 'lint' ‚Üí lo salto"
  fi
else
  echo "‚è≠Ô∏è  Skip lint (AIDUX_SKIP_LINT=1)"
fi
