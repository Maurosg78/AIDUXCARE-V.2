
> aiduxcare-v2@0.1.0 test /Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2
> vitest --config config/vitest.config.ts


 DEV  v1.6.1 /Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2

 ❯ src/core/fhir/__tests__/adapters.integration.test.ts  (0 test)
 ✓ src/core/fhir/__tests__/validators.test.ts  (21 tests) 15ms
 ✓ src/core/fhir/__tests__/adapters.test.ts  (20 tests) 18ms
 ✓ __tests__/evals/AudioCaptureService.eval.test.ts  (12 tests) 17ms
stdout | __tests__/evals/AudioCaptureService.eval.test.ts > EVAL: Sistema de Escucha Activa Clínica > Integración con EMR > formatea correctamente el contenido para insertarlo en el EMR
Direct function called with segments: 10
Direct function returning: 🔊 **Resumen de consulta (transcripción asistida)*...

stdout | __tests__/evals/AudioCaptureService.eval.test.ts > EVAL: Sistema de Escucha Activa Clínica > Integración con EMR > inserta correctamente el contenido aprobado en el EMR
Direct function called with segments: 10
Direct function returning: 🔊 **Resumen de consulta (transcripción asistida)*...

stdout | __tests__/evals/AudioCaptureService.eval.test.ts > EVAL: Sistema de Escucha Activa Clínica > debe manejar correctamente la transcripción de múltiples oradores
MultiSpeakerTranscript: 10
Direct function called with segments: 10
Direct function returning: 🔊 **Resumen de consulta (transcripción asistida)*...
Result: 🔊 **Resumen de consulta (transcripción asistida)**

**Profesional sanitario:**
- Buenos días, soy el Dr. Martínez. ¿Cómo se encuentra hoy?
- ¿Puede describirme cómo es ese dolor? ¿Es constante o aparece con ciertos movimientos?
- ¿Ha notado inflamación en la rodilla? ¿O algún sonido al mover la articulación?
- Vamos a examinar la rodilla y solicitar algunas pruebas diagnósticas para determinar la causa exacta.
- Es posible. Después de ver los resultados, evaluaremos si necesita fisioterapia o si hay que considerar otras opciones de tratamiento.

**Paciente:**
- Buenos días doctor. Vengo por el dolor en la rodilla derecha que llevo sintiendo varias semanas.
- Es más fuerte cuando subo escaleras o me levanto después de estar sentado mucho tiempo.
- Sí, a veces se me hincha, sobre todo al final del día. Y siento como si crujiera cuando la doblo.

**Acompañante:**
- También le duele por las noches. A veces se despierta por el dolor y tiene que tomar analgésicos.
- Doctor, ¿cree que podría necesitar fisioterapia? Ya tuvo problemas similares hace unos años.


stdout | __tests__/evals/AudioCaptureService.eval.test.ts > EVAL: Sistema de Escucha Activa Clínica > debe manejar correctamente la transcripción con errores
ErrorTranscript: 10
Direct function called with segments: 10
Direct function returning: 🔊 **Resumen de consulta (transcripción asistida)*...
Result for errors: 🔊 **Resumen de consulta (transcripción asistida)**

**Profesional sanitario:**
- Buenos días, vamos a revisar sus resultados de laboratorio.
- He notado que sus niveles de glucosa están un poco elevados. ¿Ha modificado su dieta recientemente?
- Entiendo. Vamos a ajustar su medicación y establecer un plan de seguimiento más riguroso.
- ...frecuencia... intensidad...

**Paciente:**
- Gracias doctor. Estaba preocupado por... (inaudible)
- (ruido de fondo) ...sido difícil mantener... durante las fiestas...
- Doctor, también quería preguntarle sobre estos dolores de cabeza que...
- Casi todos los días, especialmente por la tarde.

**Acompañante:**
- (inaudible) ...
- Y ha estado tomando analgésicos sin receta, pero no le hacen mucho efecto.


stdout | __tests__/evals/AudioCaptureService.eval.test.ts > EVAL: Sistema de Escucha Activa Clínica > debe manejar correctamente la transcripción vacía
EmptyTranscript: 0
Direct function called with segments: 0
Result for empty: 🔊 **Resumen de consulta (transcripción asistida - sin datos)**

 ✓ src/core/fhir/tests/utils.test.ts  (33 tests) 21ms
 ❯ node_modules.rescue.1758834503/@bcoe/v8-coverage/src/test/merge.spec.ts  (0 test)
 ❯ src/core/fhir/__tests__/contracts.public-api.test.ts  (0 test)
 ❯ src/core/assistant/__tests__/extractEntities.spec.ts  (17 tests | 7 failed) 37ms
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer medicamentos correctamente
     → expected undefined to be 7 // Object.is equality
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer diagnósticos neurológicos
     → expected [ { kind: 'diagnosis', …(2) } ] to have a length of 2 but got 1
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer procedimientos de evaluación
     → expected [ { kind: 'procedure', …(2) } ] to have a length of 2 but got 1
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer técnicas de fisioterapia
     → expected [ { kind: 'procedure', …(2) } ] to have a length of 2 but got 1
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer precauciones
     → expected 'Evitar movimientos bruscos y precauci…' to be 'Evitar movimientos bruscos' // Object.is equality
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer entidades mixtas correctamente
     → expected false to be true // Object.is equality
   ❯ src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > validateExtractedEntities > debe calcular calidad promedio correctamente
     → expected 0.8000000000000002 to be 0.8 // Object.is equality
 ✓ src/core/fhir/__tests__/fhirTypes.test.ts  (10 tests) 19ms
 ❯ src/core/assistant/__tests__/rails.spec.ts  (22 tests | 5 failed) 55ms
   ❯ src/core/assistant/__tests__/rails.spec.ts > RAILS System > validateClinicalQuery > debe rechazar consultas genéricas
     → expected true to be false // Object.is equality
   ❯ src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe asignar confianza media para consultas generales
     → expected 0.85 to be less than 0.8
   ❯ src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe incrementar confianza por palabras clave técnicas
     → expected 0.85 to be greater than 0.9
   ❯ src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe manejar consultas mixtas correctamente
     → expected 1 to be less than 0.9
   ❯ src/core/assistant/__tests__/rails.spec.ts > RAILS System > Integración RAILS > debe rechazar consulta no médica completamente
     → expected 0.5 to be less than 0.5
 ❯ src/core/emr/__tests__/medications.spec.ts  (9 tests | 9 failed) 29ms
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe agregar medicamento a la visita correctamente
     → addMedicationToVisit is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe manejar medicamentos sin campos opcionales
     → addMedicationToVisit is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe manejar errores de Firestore
     → addMedicationToVisit is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe formatear medicamento completo correctamente
     → formatSoapFromMedication is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe formatear medicamento básico correctamente
     → formatSoapFromMedication is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe incluir instrucciones de administración
     → formatSoapFromMedication is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe manejar medicamentos con instrucciones personalizadas
     → formatSoapFromMedication is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > Integración completa > debe agregar medicamento y generar SOAP correctamente
     → addMedicationToVisit is not a function
   ❯ src/core/emr/__tests__/medications.spec.ts > MedicationService > Integración completa > debe manejar flujo completo con errores
     → addMedicationToVisit is not a function
 ❯ src/__tests__/auth-flow.integration.test.tsx  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-types.test.ts  (0 test)
 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts  (11 tests | 5 failed) 33ms
   ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > routeQuery > debe detectar consultas mixtas (datos + conocimiento)
     → expected 0.9 to be 0.7 // Object.is equality
   ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas de datos correctamente
     → expected undefined to deeply equal { age: 35 }
   ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas LLM correctamente
     → expected undefined to deeply equal [ { kind: 'exercise', …(1) } ]
   ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas mixtas correctamente
     → expected 'La edad del paciente es 35 años\n\nLa…' to contain 'Para su edad, recomiendo ejercicios d…'
   ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar errores correctamente
     → expected true to be false // Object.is equality
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-custom-expect-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-custom-expect-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-custom-expect-types.test.ts  (0 test)
 ❯ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-custom-expect-types.test.ts  (0 test)
 ❯ src/core/fhir/__tests__/snapshots/patient.snapshot.test.ts  (1 test | 1 failed) 12ms
   ❯ src/core/fhir/__tests__/snapshots/patient.snapshot.test.ts > FHIR Patient snapshot > matches expected snapshot for a representative internal patient
     → scrubFhirResource is not a function
 ❯ src/core/fhir/__tests__/snapshots/encounter.snapshot.test.ts  (1 test | 1 failed) 10ms
   ❯ src/core/fhir/__tests__/snapshots/encounter.snapshot.test.ts > FHIR Encounter snapshot > matches expected snapshot for an ambulatory encounter
     → scrubFhirResource is not a function
 ✓ src/tests/basic.test.ts  (5 tests) 7ms
 ✓ src/utils/cleanVertexResponse.test.ts  (2 tests) 14ms
 ✓ __tests__/minimal.test.ts  (3 tests) 5ms
 ↓ test/firebase.alias.real.test.ts  (1 test | 1 skipped)
 ✓ test/firebase.alias.test.ts  (1 test) 3ms
 ✓ test/sanity.test.ts  (1 test) 4ms
 ✓ test/WelcomePage.test.tsx  (1 test) 3ms
 ✓ test/Router.smoke.test.tsx  (1 test) 3ms

⎯⎯⎯⎯⎯⎯ Failed Suites 12 ⎯⎯⎯⎯⎯⎯

 FAIL  src/__tests__/auth-flow.integration.test.tsx [ src/__tests__/auth-flow.integration.test.tsx ]
Error: Transform failed with 1 error:
/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/src/pages/VerifyEmailPage.tsx:121:1: ERROR: Syntax error "n"
 ❯ failureErrorWithLog node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:1472:15
 ❯ node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:755:50
 ❯ responseCallbacks.<computed> node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:622:9
 ❯ handleIncomingPacket node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:677:12
 ❯ Socket.readFromStdout node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:600:7
 ❯ Socket.emit node:events:524:28

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/40]⎯

 FAIL  src/core/fhir/__tests__/adapters.integration.test.ts [ src/core/fhir/__tests__/adapters.integration.test.ts ]
Error: Failed to resolve import "./validators" from "src/core/fhir/public-api.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/40]⎯

 FAIL  src/core/fhir/__tests__/contracts.public-api.test.ts [ src/core/fhir/__tests__/contracts.public-api.test.ts ]
Error: Failed to resolve import "./validators" from "src/core/fhir/public-api.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/40]⎯

 FAIL  node_modules.rescue.1758834503/@bcoe/v8-coverage/src/test/merge.spec.ts [ node_modules.rescue.1758834503/@bcoe/v8-coverage/src/test/merge.spec.ts ]
Error: Failed to resolve import "chai" from "node_modules.rescue.1758834503/@bcoe/v8-coverage/src/test/merge.spec.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-custom-expect-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-custom-expect-types.test.ts ]
Error: Failed to resolve import "bun:test" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-custom-expect-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-types.test.ts ]
Error: Failed to resolve import "bun:test" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/bun/bun-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-custom-expect-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-custom-expect-types.test.ts ]
Error: Failed to resolve import "../../matchers" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-custom-expect-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-types.test.ts ]
Error: Failed to resolve import "../../jest" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest/jest-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-custom-expect-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-custom-expect-types.test.ts ]
Error: Failed to resolve import "@jest/globals" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-custom-expect-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-types.test.ts ]
Error: Failed to resolve import "@jest/globals" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/jest-globals/jest-globals-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-custom-expect-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-custom-expect-types.test.ts ]
Error: Failed to resolve import "../../matchers" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-custom-expect-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/40]⎯

 FAIL  node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-types.test.ts [ node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-types.test.ts ]
Error: Failed to resolve import "../../vitest" from "node_modules.rescue.1758834503/@testing-library/jest-dom/types/__tests__/vitest/vitest-types.test.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49258:41
 ❯ TransformPluginContext.error node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49253:16
 ❯ normalizeUrl node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64306:23
 ❯ async file:/Users/mauriciosobarzo/Desktop/AIDUXCARE-V.2/node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64438:39
 ❯ TransformPluginContext.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:64365:7
 ❯ PluginContainer.transform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:49099:18
 ❯ loadAndTransform node_modules/.pnpm/vite@5.4.20_@types+node@20.19.17/node_modules/vite/dist/node/chunks/dep-D_zLpgQd.js:51977:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/40]⎯

⎯⎯⎯⎯⎯⎯ Failed Tests 28 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > routeQuery > debe detectar consultas mixtas (datos + conocimiento)
AssertionError: expected 0.9 to be 0.7 // Object.is equality

- Expected
+ Received

- 0.7
+ 0.9

 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts:67:33
     65|       
     66|       expect(result.type).toBe('both');
     67|       expect(result.confidence).toBe(0.7);
       |                                 ^
     68|     });
     69| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/40]⎯

 FAIL  src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas de datos correctamente
AssertionError: expected undefined to deeply equal { age: 35 }

- Expected: 
Object {
  "age": 35,
}

+ Received: 
undefined

 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts:102:27
    100|       expect(result.routeType).toBe('data');
    101|       expect(result.answerMarkdown).toBe('La edad del paciente es 35 a…
    102|       expect(result.data).toEqual({ age: 35 });
       |                           ^
    103|       expect(result.confidence).toBe(0.95);
    104|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/40]⎯

 FAIL  src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas LLM correctamente
AssertionError: expected undefined to deeply equal [ { kind: 'exercise', …(1) } ]

- Expected: 
Array [
  Object {
    "kind": "exercise",
    "name": "estabilización lumbar",
  },
]

+ Received: 
undefined

 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts:121:31
    119|       expect(result.routeType).toBe('llm');
    120|       expect(result.answerMarkdown).toBe('Para el dolor lumbar, recomi…
    121|       expect(result.entities).toEqual([{ kind: 'exercise', name: 'esta…
       |                               ^
    122|       expect(result.confidence).toBe(0.8);
    123|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/40]⎯

 FAIL  src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar consultas mixtas correctamente
AssertionError: expected 'La edad del paciente es 35 años\n\nLa…' to contain 'Para su edad, recomiendo ejercicios d…'

- Expected
+ Received

- Para su edad, recomiendo ejercicios de bajo impacto
+ La edad del paciente es 35 años
+
+ La edad del paciente es 45 años

 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts:150:37
    148|       expect(result.routeType).toBe('both');
    149|       expect(result.answerMarkdown).toContain('La edad del paciente es…
    150|       expect(result.answerMarkdown).toContain('Para su edad, recomiend…
       |                                     ^
    151|       expect(result.confidence).toBe(0.7);
    152|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/40]⎯

 FAIL  src/core/assistant/__tests__/assistantAdapter.spec.ts > AssistantAdapter > runAssistantQuery > debe manejar errores correctamente
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 ❯ src/core/assistant/__tests__/assistantAdapter.spec.ts:161:25
    159|       });
    160| 
    161|       expect(result.ok).toBe(false);
       |                         ^
    162|       expect(result.error).toBe('Error de red');
    163|       expect(result.confidence).toBe(0);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer medicamentos correctamente
AssertionError: expected undefined to be 7 // Object.is equality

- Expected: 
7

+ Received: 
undefined

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:19:32
     17|       expect(med.strength).toBe('400 mg');
     18|       expect(med.frequency).toBe('cada 8 horas');
     19|       expect(med.durationDays).toBe(7);
       |                                ^
     20|       expect(med.confidence).toBe(0.9);
     21|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer diagnósticos neurológicos
AssertionError: expected [ { kind: 'diagnosis', …(2) } ] to have a length of 2 but got 1

- Expected
+ Received

- 2
+ 1

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:58:24
     56|       const entities = extractEntities(input);
     57|       
     58|       expect(entities).toHaveLength(2);
       |                        ^
     59|       expect(entities.every(e => e.kind === 'diagnosis')).toBe(true);
     60|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer procedimientos de evaluación
AssertionError: expected [ { kind: 'procedure', …(2) } ] to have a length of 2 but got 1

- Expected
+ Received

- 2
+ 1

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:72:24
     70|       const entities = extractEntities(input);
     71|       
     72|       expect(entities).toHaveLength(2);
       |                        ^
     73|       expect(entities.every(e => e.kind === 'procedure')).toBe(true);
     74|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer técnicas de fisioterapia
AssertionError: expected [ { kind: 'procedure', …(2) } ] to have a length of 2 but got 1

- Expected
+ Received

- 2
+ 1

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:87:24
     85|       const entities = extractEntities(input);
     86|       
     87|       expect(entities).toHaveLength(2);
       |                        ^
     88|       expect(entities.every(e => e.kind === 'procedure')).toBe(true);
     89|       

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer precauciones
AssertionError: expected 'Evitar movimientos bruscos y precauci…' to be 'Evitar movimientos bruscos' // Object.is equality

- Expected
+ Received

- Evitar movimientos bruscos
+ Evitar movimientos bruscos y precaución con el dolor

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:119:26
    117|       const inst2 = entities[1] as InstructionEntity;
    118|       
    119|       expect(inst1.text).toBe('Evitar movimientos bruscos');
       |                          ^
    120|       expect(inst2.text).toBe('precaución con el dolor');
    121|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > extractEntities > debe extraer entidades mixtas correctamente
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:142:28
    140|       expect(hasDiagnosis).toBe(true);
    141|       expect(hasMedication).toBe(true);
    142|       expect(hasProcedure).toBe(true);
       |                            ^
    143|     });
    144|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/40]⎯

 FAIL  src/core/assistant/__tests__/extractEntities.spec.ts > ExtractEntities System > validateExtractedEntities > debe calcular calidad promedio correctamente
AssertionError: expected 0.8000000000000002 to be 0.8 // Object.is equality

- Expected
+ Received

- 0.8
+ 0.8000000000000002

 ❯ src/core/assistant/__tests__/extractEntities.spec.ts:251:35
    249|       
    250|       expect(result.validEntities).toHaveLength(3);
    251|       expect(result.qualityScore).toBe(0.8); // (0.8 + 0.9 + 0.7) / 3
       |                                   ^
    252|     });
    253| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/40]⎯

 FAIL  src/core/assistant/__tests__/rails.spec.ts > RAILS System > validateClinicalQuery > debe rechazar consultas genéricas
AssertionError: expected true to be false // Object.is equality

- Expected
+ Received

- false
+ true

 ❯ src/core/assistant/__tests__/rails.spec.ts:99:30
     97|       const result = validateClinicalQuery(input);
     98|       
     99|       expect(result.isValid).toBe(false);
       |                              ^
    100|       expect(result.reason).toBe('Consulta demasiado genérica. Por fav…
    101|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/40]⎯

 FAIL  src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe asignar confianza media para consultas generales
AssertionError: expected 0.85 to be less than 0.8
 ❯ src/core/assistant/__tests__/rails.spec.ts:132:26
    130|       
    131|       expect(confidence).toBeGreaterThan(0.5);
    132|       expect(confidence).toBeLessThan(0.8);
       |                          ^
    133|     });
    134| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/40]⎯

 FAIL  src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe incrementar confianza por palabras clave técnicas
AssertionError: expected 0.85 to be greater than 0.9
 ❯ src/core/assistant/__tests__/rails.spec.ts:146:26
    144|       const confidence = getClinicalConfidence(input);
    145|       
    146|       expect(confidence).toBeGreaterThan(0.9);
       |                          ^
    147|     });
    148| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/40]⎯

 FAIL  src/core/assistant/__tests__/rails.spec.ts > RAILS System > getClinicalConfidence > debe manejar consultas mixtas correctamente
AssertionError: expected 1 to be less than 0.9
 ❯ src/core/assistant/__tests__/rails.spec.ts:154:26
    152|       
    153|       expect(confidence).toBeGreaterThan(0.6);
    154|       expect(confidence).toBeLessThan(0.9);
       |                          ^
    155|     });
    156|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[28/40]⎯

 FAIL  src/core/assistant/__tests__/rails.spec.ts > RAILS System > Integración RAILS > debe rechazar consulta no médica completamente
AssertionError: expected 0.5 to be less than 0.5
 ❯ src/core/assistant/__tests__/rails.spec.ts:188:26
    186|       // 3. Confianza
    187|       const confidence = getClinicalConfidence(input);
    188|       expect(confidence).toBeLessThan(0.5);
       |                          ^
    189|     });
    190|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[29/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe agregar medicamento a la visita correctamente
TypeError: addMedicationToVisit is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:42:28
     40|       vi.mocked(addDoc).mockResolvedValue(mockDocRef);
     41| 
     42|       const result = await addMedicationToVisit('visit-123', mockMedic…
       |                            ^
     43| 
     44|       expect(vi.mocked(addDoc)).toHaveBeenCalledWith(

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[30/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe manejar medicamentos sin campos opcionales
TypeError: addMedicationToVisit is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:69:28
     67|       vi.mocked(addDoc).mockResolvedValue(mockDocRef);
     68| 
     69|       const result = await addMedicationToVisit('visit-789', mockMedic…
       |                            ^
     70| 
     71|       expect(vi.mocked(addDoc)).toHaveBeenCalledWith(

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[31/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > addMedicationToVisit > debe manejar errores de Firestore
TypeError: addMedicationToVisit is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:92:20
     90|       vi.mocked(addDoc).mockRejectedValue(new Error('Error de Firestor…
     91| 
     92|       await expect(addMedicationToVisit('visit-error', mockMedication))
       |                    ^
     93|         .rejects.toThrow('Error de Firestore');
     94|     });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[32/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe formatear medicamento completo correctamente
TypeError: formatSoapFromMedication is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:108:22
    106|       };
    107| 
    108|       const result = formatSoapFromMedication(mockMedication);
       |                      ^
    109| 
    110|       expect(result).toContain('**Medicación:** ibuprofeno');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[33/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe formatear medicamento básico correctamente
TypeError: formatSoapFromMedication is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:123:22
    121|       };
    122| 
    123|       const result = formatSoapFromMedication(mockMedication);
       |                      ^
    124| 
    125|       expect(result).toContain('**Medicación:** paracetamol');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[34/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe incluir instrucciones de administración
TypeError: formatSoapFromMedication is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:142:22
    140|       };
    141| 
    142|       const result = formatSoapFromMedication(mockMedication);
       |                      ^
    143| 
    144|       expect(result).toContain('**Instrucciones:** Administrar con ali…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[35/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > formatSoapFromMedication > debe manejar medicamentos con instrucciones personalizadas
TypeError: formatSoapFromMedication is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:157:22
    155|       };
    156| 
    157|       const result = formatSoapFromMedication(mockMedication);
       |                      ^
    158| 
    159|       expect(result).toContain('**Instrucciones:** Solo en caso de dol…

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > Integración completa > debe agregar medicamento y generar SOAP correctamente
TypeError: addMedicationToVisit is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:178:34
    176|       vi.mocked(addDoc).mockResolvedValue(mockDocRef);
    177| 
    178|       const medicationId = await addMedicationToVisit('visit-integrati…
       |                                  ^
    179|       expect(medicationId).toBe('med-789');
    180| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/40]⎯

 FAIL  src/core/emr/__tests__/medications.spec.ts > MedicationService > Integración completa > debe manejar flujo completo con errores
TypeError: addMedicationToVisit is not a function
 ❯ src/core/emr/__tests__/medications.spec.ts:212:20
    210|       vi.mocked(addDoc).mockRejectedValue(new Error('Error de Firestor…
    211| 
    212|       await expect(addMedicationToVisit('visit-error', mockMedication))
       |                    ^
    213|         .rejects.toThrow('Error de Firestore');
    214| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/40]⎯

 FAIL  src/core/fhir/__tests__/snapshots/encounter.snapshot.test.ts > FHIR Encounter snapshot > matches expected snapshot for an ambulatory encounter
TypeError: scrubFhirResource is not a function
 ❯ src/core/fhir/__tests__/snapshots/encounter.snapshot.test.ts:29:31
     27|     
     28|     // Limpiar campos dinámicos antes del snapshot
     29|     const scrubbedEncounter = scrubFhirResource(fhirEncounter);
       |                               ^
     30|     expect(scrubbedEncounter).toMatchSnapshot();
     31|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39/40]⎯

 FAIL  src/core/fhir/__tests__/snapshots/patient.snapshot.test.ts > FHIR Patient snapshot > matches expected snapshot for a representative internal patient
TypeError: scrubFhirResource is not a function
 ❯ src/core/fhir/__tests__/snapshots/patient.snapshot.test.ts:37:29
     35|     
     36|     // Limpiar campos dinámicos antes del snapshot
     37|     const scrubbedPatient = scrubFhirResource(fhirPatient);
       |                             ^
     38|     expect(scrubbedPatient).toMatchSnapshot();
     39|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[40/40]⎯

 Test Files  18 failed | 12 passed | 1 skipped (31)
      Tests  28 failed | 143 passed | 1 skipped (172)
   Start at  14:41:35
   Duration  9.78s (transform 1.12s, setup 204ms, collect 1.30s, tests 305ms, environment 22.72s, prepare 4.76s)


 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
Cancelling test run. Press CTRL+c again to exit forcefully.

 ELIFECYCLE  Test failed. See above for more details.
