rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ---- helpers ----
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ============================================
    // WO-SEC-001: Hardening de Activación
    // Estándar: ISO/IEC 27001 · PHIPA · PIPEDA
    // ============================================
    
    // ✅ Users Collection - PROTEGIDA (WO-SEC-001)
    // Solo accesible por el usuario autenticado o para creación (onboarding)
    match /users/{userId} {
      // Lectura: Solo el propio usuario autenticado
      allow read: if 
        request.auth != null &&
        request.auth.uid == userId;
      
      // Escritura: Solo el propio usuario autenticado
      allow update: if 
        request.auth != null &&
        request.auth.uid == userId;
      
      // Creación: Permitir sin autenticación (onboarding)
      allow create: if true;
      
      // Eliminación: Prohibida (requiere proceso de borrado de datos)
      allow delete: if false;
    }
    
    // ✅ Activation Tokens Collection - CONTROLADA (WO-SEC-001)
    // Tokens de activación separados de users para cumplir compliance
    match /activation_tokens/{token} {
      // Lectura: Solo si el token no ha expirado y no ha sido usado
      allow read: if 
        resource.data.expiresAt > request.time &&
        !('usedAt' in resource.data);
      
      // Escritura: Solo para marcar como usado (single-use)
      allow update: if 
        resource.data.expiresAt > request.time &&
        !('usedAt' in resource.data) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['usedAt']) &&
        request.resource.data.usedAt == request.time;
      
      // Creación: Solo desde Cloud Functions (con permisos de servicio)
      allow create: if false;
      
      // Eliminación: Prohibida (requiere auditoría)
      allow delete: if false;
    }
    
    // Professionals
    match /professionals/{professionalId} {
      allow read, write: if isSignedIn();
    }
    
    // Patients
    match /patients/{patientId} {
      allow read, write: if isSignedIn();
    }
    
    // Episodes (Episode Treatment Plan, Clinical Vault, etc.)
    match /episodes/{episodeId} {
      allow read, write: if isSignedIn();
    }
    
    // Sessions (clinic notes, daily notes)
    match /sessions/{sessionId} {
      allow read, write: if isSignedIn();
    }
    
    // Analytics simplificado (eventos agregados, counters, etc.)
    match /analytics/{docId} {
      allow read, write: if isSignedIn();
    }
    
    // Value Analytics Collection - PHIPA Compliant
    match /value_analytics/{document} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // User Feedback Collection - Beta Testing
    match /user_feedback/{document} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Consent Verifications Collection - PHIPA Compliance
    match /consent_verifications/{document} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }
    
    // Fallback: Solo para colecciones autenticadas
    // IMPORTANTE: Revisar antes de producción
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
    
  }
}

