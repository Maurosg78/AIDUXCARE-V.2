name: ðŸ§¹ Code Maintenance & Quality Assurance

on:
  # Ejecutar en cada push a main
  push:
    branches: [ main, master ]
  
  # Ejecutar en cada PR
  pull_request:
    branches: [ main, master ]
  
  # Ejecutar semanalmente (lunes a las 9 AM UTC)
  schedule:
    - cron: '0 9 * * 1'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ðŸ” AuditorÃ­a y Limpieza Semanal
  weekly-cleanup:
    name: ðŸ“Š Weekly Cleanup & Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --force
        
      - name: ðŸ§¹ Execute Weekly Cleanup
        run: npm run cleanup:weekly
        continue-on-error: true
        
      - name: ðŸ“Š Execute File Audit
        run: npm run audit:files
        continue-on-error: true
        
      - name: ðŸ“ Validate Structure
        run: npm run validate:structure
        continue-on-error: true
        
      - name: ðŸ“„ Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maintenance-reports-${{ github.run_number }}
          path: |
            cleanup-report.json
            audit-report-*.json
            structure-validation-*.json
          retention-days: 30

  # ðŸ”’ ValidaciÃ³n de Estructura en PRs
  pr-structure-validation:
    name: ðŸ” PR Structure Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --force
        
      - name: ðŸ” Check for Prohibited Patterns
        run: |
          echo "ðŸ” Verificando patrones prohibidos en archivos nuevos..."
          
          # Verificar archivos modificados en el PR
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "ðŸ“ Archivos modificados:"
          echo "$CHANGED_FILES"
          
          # Verificar patrones prohibidos
          VIOLATIONS=""
          
          for file in $CHANGED_FILES; do
            if [[ "$file" =~ \.backup\. ]]; then
              VIOLATIONS="$VIOLATIONS\nâŒ Archivo backup prohibido: $file"
            fi
            if [[ "$file" =~ \.old\. ]]; then
              VIOLATIONS="$VIOLATIONS\nâŒ Archivo .old prohibido: $file"
            fi
            if [[ "$file" =~ -copy\. ]]; then
              VIOLATIONS="$VIOLATIONS\nâš ï¸ Archivo copia detectado: $file"
            fi
            if [[ "$file" =~ ^INFORME_.*\.md$ ]]; then
              VIOLATIONS="$VIOLATIONS\nâŒ DocumentaciÃ³n temporal prohibida: $file"
            fi
          done
          
          if [ ! -z "$VIOLATIONS" ]; then
            echo -e "\nðŸš¨ VIOLACIONES DETECTADAS:$VIOLATIONS"
            echo -e "\nðŸ“‹ Por favor, corrige estos problemas antes de continuar."
            exit 1
          else
            echo "âœ… No se detectaron violaciones de polÃ­ticas"
          fi
          
      - name: ðŸ“ Structure Validation
        run: npm run validate:structure
        
      - name: ðŸ§ª Build Test
        run: npm run build
        
      - name: âœ… Quality Gate
        run: |
          echo "ðŸŽ¯ Verificando calidad general..."
          
          # Verificar que el build fue exitoso
          if [ ! -d "dist" ]; then
            echo "âŒ Build fallÃ³ - directorio dist no encontrado"
            exit 1
          fi
          
          echo "âœ… Todas las verificaciones de calidad pasaron"

  # ðŸ”§ Build y Test en Push
  build-and-test:
    name: ðŸ”§ Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --force
        
      - name: ðŸ” Lint Check
        run: npm run lint
        continue-on-error: true
        
      - name: ðŸ§ª Type Check
        run: npm run type-check
        continue-on-error: true
        
      - name: ðŸ”§ Build Production
        run: npm run build
        
      - name: ðŸ“Š Quick Structure Check
        run: npm run validate:structure
        continue-on-error: true
        
      - name: ðŸ’¾ Cache Build
        uses: actions/cache@v4
        with:
          path: dist
          key: build-${{ github.sha }}
          
  # ðŸ“ˆ MÃ©tricas de Calidad
  quality-metrics:
    name: ðŸ“ˆ Quality Metrics
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: npm ci --force
        
      - name: ðŸ“Š Generate Quality Report
        run: |
          echo "ðŸ“Š Generando mÃ©tricas de calidad..."
          
          # Contar archivos por tipo
          TS_FILES=$(find src -name "*.ts" -o -name "*.tsx" | wc -l)
          TEST_FILES=$(find . -name "*.test.*" -o -name "*.spec.*" | wc -l)
          CONFIG_FILES=$(find . -maxdepth 2 -name "*.config.*" | wc -l)
          MD_FILES=$(find . -name "*.md" | wc -l)
          
          echo "ðŸ“ˆ MÃ‰TRICAS DE CALIDAD:"
          echo "â€¢ Archivos TypeScript: $TS_FILES"
          echo "â€¢ Archivos de test: $TEST_FILES"
          echo "â€¢ Archivos de config: $CONFIG_FILES"
          echo "â€¢ Archivos de documentaciÃ³n: $MD_FILES"
          
          # Calcular ratios
          if [ $TS_FILES -gt 0 ]; then
            TEST_RATIO=$(echo "scale=2; $TEST_FILES * 100 / $TS_FILES" | bc -l)
            DOC_RATIO=$(echo "scale=2; $MD_FILES * 100 / $TS_FILES" | bc -l)
            
            echo "â€¢ Ratio de tests: ${TEST_RATIO}%"
            echo "â€¢ Ratio de documentaciÃ³n: ${DOC_RATIO}%"
            
            # Verificar umbrales de calidad
            if (( $(echo "$DOC_RATIO > 15" | bc -l) )); then
              echo "âš ï¸ ADVERTENCIA: Ratio de documentaciÃ³n alto (>15%)"
            fi
            
            if (( $(echo "$TEST_RATIO < 10" | bc -l) )); then
              echo "âš ï¸ ADVERTENCIA: Ratio de tests bajo (<10%)"
            fi
          fi
          
      - name: ðŸ“„ Archive Quality Report
        run: |
          echo "Timestamp: $(date)" > quality-metrics.txt
          echo "Commit: ${{ github.sha }}" >> quality-metrics.txt
          echo "Branch: ${{ github.ref_name }}" >> quality-metrics.txt
          
      - name: ðŸ“¤ Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: quality-metrics-${{ github.run_number }}
          path: quality-metrics.txt
          retention-days: 30 