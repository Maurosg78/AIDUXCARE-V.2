/**
 * ðŸ“š Knowledge Base Service - AiDuxCare V.2
 * Base de conocimiento especializada para fisioterapia
 * ImplementaciÃ³n del Blueprint Oficial
 */

import ProfessionalProfileService, { ProfessionalProfile } from './ProfessionalProfileService';

export interface MedicalKnowledge {
  id: string;
  category: 'pathology' | 'technique' | 'test' | 'medication' | 'protocol';
  title: string;
  description: string;
  content: string;
  countries: string[];
  specialties: string[];
  certifications: string[];
  contraindications: string[];
  references: string[];
  lastUpdated: Date;
}

export interface ClinicalProtocol {
  id: string;
  name: string;
  description: string;
  indications: string[];
  contraindications: string[];
  steps: string[];
  expectedOutcomes: string[];
  timeline: string;
  countries: string[];
  specialties: string[];
}

export interface DiagnosticTest {
  id: string;
  name: string;
  category: 'orthopedic' | 'neurological' | 'cardiorespiratory' | 'functional';
  description: string;
  procedure: string[];
  positiveSigns: string[];
  negativeSigns: string[];
  contraindications: string[];
  reliability: number; // 0-100
  countries: string[];
}

export class KnowledgeBaseService {
  private static instance: KnowledgeBaseService;
  private profileService: ProfessionalProfileService;
  private medicalKnowledge: Map<string, MedicalKnowledge> = new Map();
  private clinicalProtocols: Map<string, ClinicalProtocol> = new Map();
  private diagnosticTests: Map<string, DiagnosticTest> = new Map();

  private constructor() {
    this.profileService = ProfessionalProfileService.getInstance();
    this.initializeKnowledgeBase();
  }

  static getInstance(): KnowledgeBaseService {
    if (!KnowledgeBaseService.instance) {
      KnowledgeBaseService.instance = new KnowledgeBaseService();
    }
    return KnowledgeBaseService.instance;
  }

  /**
   * Inicializar base de conocimiento mÃ©dica
   */
  private initializeKnowledgeBase(): void {
    // PatologÃ­as comunes en fisioterapia
    this.initializePathologies();
    
    // TÃ©cnicas de tratamiento
    this.initializeTechniques();
    
    // Tests diagnÃ³sticos
    this.initializeDiagnosticTests();
    
    // Protocolos clÃ­nicos
    this.initializeClinicalProtocols();
    
    console.log('ðŸ“š Base de conocimiento inicializada');
    console.log(`   - PatologÃ­as: ${Array.from(this.medicalKnowledge.values()).filter(k => k.category === 'pathology').length}`);
    console.log(`   - TÃ©cnicas: ${Array.from(this.medicalKnowledge.values()).filter(k => k.category === 'technique').length}`);
    console.log(`   - Tests: ${this.diagnosticTests.size}`);
    console.log(`   - Protocolos: ${this.clinicalProtocols.size}`);
  }

  /**
   * Inicializar patologÃ­as
   */
  private initializePathologies(): void {
    const pathologies: MedicalKnowledge[] = [
      {
        id: 'path-001',
        category: 'pathology',
        title: 'Lumbalgia MecÃ¡nica',
        description: 'Dolor lumbar de origen mecÃ¡nico',
        content: 'La lumbalgia mecÃ¡nica es el dolor lumbar que se origina en estructuras musculoesquelÃ©ticas...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Ortopedia', 'Deportiva'],
        certifications: [],
        contraindications: ['Fractura vertebral', 'InfecciÃ³n', 'CÃ¡ncer'],
        references: ['Clinical Practice Guidelines for Low Back Pain'],
        lastUpdated: new Date()
      },
      {
        id: 'path-002',
        category: 'pathology',
        title: 'SÃ­ndrome de Pinzamiento Subacromial',
        description: 'CompresiÃ³n de estructuras subacromiales',
        content: 'El sÃ­ndrome de pinzamiento subacromial se caracteriza por dolor en el hombro...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Ortopedia', 'Deportiva'],
        certifications: [],
        contraindications: ['Fractura de hombro', 'LuxaciÃ³n reciente'],
        references: ['Shoulder Impingement Syndrome Guidelines'],
        lastUpdated: new Date()
      },
      {
        id: 'path-003',
        category: 'pathology',
        title: 'Espondiloartritis',
        description: 'Enfermedad inflamatoria sistÃ©mica',
        content: 'La espondiloartritis es una enfermedad inflamatoria que afecta principalmente la columna...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['ReumatologÃ­a'],
        certifications: [],
        contraindications: ['Fase aguda severa'],
        references: ['ASAS Classification Criteria'],
        lastUpdated: new Date()
      }
    ];

    pathologies.forEach(pathology => {
      this.medicalKnowledge.set(pathology.id, pathology);
    });
  }

  /**
   * Inicializar tÃ©cnicas
   */
  private initializeTechniques(): void {
    const techniques: MedicalKnowledge[] = [
      {
        id: 'tech-001',
        category: 'technique',
        title: 'Terapia Manual',
        description: 'TÃ©cnicas manuales de fisioterapia',
        content: 'La terapia manual incluye movilizaciones, manipulaciones y tÃ©cnicas de tejido blando...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Ortopedia', 'NeurologÃ­a'],
        certifications: ['Terapia Manual'],
        contraindications: ['Fractura reciente', 'InfecciÃ³n activa', 'CÃ¡ncer activo'],
        references: ['Manual Therapy Guidelines'],
        lastUpdated: new Date()
      },
      {
        id: 'tech-002',
        category: 'technique',
        title: 'PunciÃ³n Seca',
        description: 'TÃ©cnica de punciÃ³n para puntos gatillo',
        content: 'La punciÃ³n seca es una tÃ©cnica invasiva para el tratamiento de puntos gatillo...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Ortopedia', 'Dolor'],
        certifications: ['PunciÃ³n Seca'],
        contraindications: ['Trastornos de coagulaciÃ³n', 'InfecciÃ³n local', 'Embarazo'],
        references: ['Dry Needling Guidelines'],
        lastUpdated: new Date()
      },
      {
        id: 'tech-003',
        category: 'technique',
        title: 'Acupuntura',
        description: 'TÃ©cnica de medicina tradicional china',
        content: 'La acupuntura utiliza agujas finas en puntos especÃ­ficos del cuerpo...',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Dolor', 'NeurologÃ­a'],
        certifications: ['Acupuntura'],
        contraindications: ['Trastornos de coagulaciÃ³n', 'InfecciÃ³n local', 'Embarazo'],
        references: ['Acupuncture Guidelines'],
        lastUpdated: new Date()
      }
    ];

    techniques.forEach(technique => {
      this.medicalKnowledge.set(technique.id, technique);
    });
  }

  /**
   * Inicializar tests diagnÃ³sticos
   */
  private initializeDiagnosticTests(): void {
    const tests: DiagnosticTest[] = [
      {
        id: 'test-001',
        name: 'Test de LasÃ¨gue',
        category: 'orthopedic',
        description: 'EvaluaciÃ³n de irritaciÃ³n radicular lumbar',
        procedure: [
          'Paciente en decÃºbito supino',
          'Elevar la pierna extendida',
          'Observar reproducciÃ³n del dolor radicular'
        ],
        positiveSigns: [
          'ReproducciÃ³n del dolor radicular',
          'Dolor antes de 60Â° de elevaciÃ³n',
          'Dolor en distribuciÃ³n dermatomal'
        ],
        negativeSigns: [
          'No reproducciÃ³n del dolor',
          'Dolor solo en muslo posterior',
          'ElevaciÃ³n > 60Â° sin dolor radicular'
        ],
        contraindications: ['Fractura vertebral', 'Inestabilidad lumbar'],
        reliability: 85,
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡']
      },
      {
        id: 'test-002',
        name: 'Test de Neer',
        category: 'orthopedic',
        description: 'EvaluaciÃ³n de pinzamiento subacromial',
        procedure: [
          'Paciente sentado',
          'Elevar el brazo en flexiÃ³n',
          'Observar reproducciÃ³n del dolor'
        ],
        positiveSigns: [
          'ReproducciÃ³n del dolor subacromial',
          'Dolor en arco doloroso',
          'CrepitaciÃ³n subacromial'
        ],
        negativeSigns: [
          'No reproducciÃ³n del dolor',
          'Movimiento completo sin dolor'
        ],
        contraindications: ['Fractura de hombro', 'LuxaciÃ³n reciente'],
        reliability: 78,
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡']
      },
      {
        id: 'test-003',
        name: 'Test de Timed Up and Go',
        category: 'functional',
        description: 'EvaluaciÃ³n de movilidad y equilibrio',
        procedure: [
          'Paciente sentado en silla',
          'Levantarse y caminar 3 metros',
          'Girar y regresar a la silla',
          'Medir tiempo total'
        ],
        positiveSigns: [
          'Tiempo > 20 segundos',
          'Inestabilidad durante la marcha',
          'Necesidad de ayuda'
        ],
        negativeSigns: [
          'Tiempo < 10 segundos',
          'Marcha estable',
          'Sin necesidad de ayuda'
        ],
        contraindications: ['Inestabilidad severa', 'Dolor agudo'],
        reliability: 92,
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡']
      }
    ];

    tests.forEach(test => {
      this.diagnosticTests.set(test.id, test);
    });
  }

  /**
   * Inicializar protocolos clÃ­nicos
   */
  private initializeClinicalProtocols(): void {
    const protocols: ClinicalProtocol[] = [
      {
        id: 'protocol-001',
        name: 'Protocolo de Lumbalgia Aguda',
        description: 'Manejo de lumbalgia aguda mecÃ¡nica',
        indications: ['Dolor lumbar agudo < 6 semanas', 'Origen mecÃ¡nico', 'Sin banderas rojas'],
        contraindications: ['Banderas rojas', 'Dolor crÃ³nico', 'PatologÃ­a sistÃ©mica'],
        steps: [
          'EvaluaciÃ³n inicial completa',
          'EducaciÃ³n del paciente',
          'Ejercicios de estabilizaciÃ³n',
          'ProgresiÃ³n gradual de actividad'
        ],
        expectedOutcomes: [
          'ReducciÃ³n del dolor en 2 semanas',
          'Mejora de la movilidad',
          'Retorno a actividades normales'
        ],
        timeline: '4-6 semanas',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['Ortopedia']
      },
      {
        id: 'protocol-002',
        name: 'Protocolo de RehabilitaciÃ³n Post-ACV',
        description: 'RehabilitaciÃ³n neurolÃ³gica post-accidente cerebrovascular',
        indications: ['Secuelas de ACV', 'Hemiparesia', 'AlteraciÃ³n de marcha'],
        contraindications: ['ACV agudo', 'Inestabilidad mÃ©dica', 'Contraindicaciones mÃ©dicas'],
        steps: [
          'EvaluaciÃ³n neurolÃ³gica completa',
          'Ejercicios de Bobath',
          'Entrenamiento de marcha',
          'Actividades de la vida diaria'
        ],
        expectedOutcomes: [
          'Mejora de la funciÃ³n motora',
          'Independencia en marcha',
          'Mejora de actividades diarias'
        ],
        timeline: '6-12 meses',
        countries: ['EspaÃ±a', 'MÃ©xico', 'Estados Unidos', 'CanadÃ¡'],
        specialties: ['NeurologÃ­a']
      }
    ];

    protocols.forEach(protocol => {
      this.clinicalProtocols.set(protocol.id, protocol);
    });
  }

  /**
   * Buscar conocimiento personalizado segÃºn perfil profesional
   */
  async searchPersonalizedKnowledge(
    professionalProfileId: string,
    query: string,
    category?: string
  ): Promise<MedicalKnowledge[]> {
    const profile = this.profileService.getProfile(professionalProfileId);
    if (!profile) {
      return [];
    }

    const results: MedicalKnowledge[] = [];
    const queryLower = query.toLowerCase();

    for (const knowledge of this.medicalKnowledge.values()) {
      // Filtrar por paÃ­s
      if (!knowledge.countries.includes(profile.country)) {
        continue;
      }

      // Filtrar por especialidad
      if (knowledge.specialties.length > 0 && 
          !knowledge.specialties.some(spec => profile.specialties.includes(spec))) {
        continue;
      }

      // Filtrar por certificaciones
      if (knowledge.certifications.length > 0 && 
          !knowledge.certifications.some(cert => profile.certifications.includes(cert))) {
        continue;
      }

      // Filtrar por categorÃ­a
      if (category && knowledge.category !== category) {
        continue;
      }

      // Buscar en contenido
      if (knowledge.title.toLowerCase().includes(queryLower) ||
          knowledge.description.toLowerCase().includes(queryLower) ||
          knowledge.content.toLowerCase().includes(queryLower)) {
        results.push(knowledge);
      }
    }

    return results.sort((a, b) => b.lastUpdated.getTime() - a.lastUpdated.getTime());
  }

  /**
   * Obtener tests diagnÃ³sticos sugeridos
   */
  getSuggestedTests(
    professionalProfileId: string,
    symptoms: string[],
    specialty: string
  ): DiagnosticTest[] {
    const profile = this.profileService.getProfile(professionalProfileId);
    if (!profile) {
      return [];
    }

    const suggestedTests: DiagnosticTest[] = [];
    const symptomsLower = symptoms.map(s => s.toLowerCase());

    for (const test of this.diagnosticTests.values()) {
      // Filtrar por paÃ­s
      if (!test.countries.includes(profile.country)) {
        continue;
      }

      // Filtrar por especialidad
      if (test.category === 'orthopedic' && !profile.specialties.includes('Ortopedia')) {
        continue;
      }
      if (test.category === 'neurological' && !profile.specialties.includes('NeurologÃ­a')) {
        continue;
      }

      // Sugerir tests basados en sÃ­ntomas
      let shouldSuggest = false;

      if (symptomsLower.some(s => s.includes('dolor lumbar') || s.includes('lumbalgia'))) {
        if (test.name.toLowerCase().includes('lasÃ¨gue') || test.name.toLowerCase().includes('lasegue')) {
          shouldSuggest = true;
        }
      }

      if (symptomsLower.some(s => s.includes('hombro') || s.includes('dolor hombro'))) {
        if (test.name.toLowerCase().includes('neer')) {
          shouldSuggest = true;
        }
      }

      if (symptomsLower.some(s => s.includes('equilibrio') || s.includes('marcha'))) {
        if (test.name.toLowerCase().includes('timed up and go')) {
          shouldSuggest = true;
        }
      }

      if (shouldSuggest) {
        suggestedTests.push(test);
      }
    }

    return suggestedTests.sort((a, b) => b.reliability - a.reliability);
  }

  /**
   * Obtener protocolos clÃ­nicos relevantes
   */
  getRelevantProtocols(
    professionalProfileId: string,
    diagnosis: string,
    specialty: string
  ): ClinicalProtocol[] {
    const profile = this.profileService.getProfile(professionalProfileId);
    if (!profile) {
      return [];
    }

    const relevantProtocols: ClinicalProtocol[] = [];
    const diagnosisLower = diagnosis.toLowerCase();

    for (const protocol of this.clinicalProtocols.values()) {
      // Filtrar por paÃ­s
      if (!protocol.countries.includes(profile.country)) {
        continue;
      }

      // Filtrar por especialidad
      if (!protocol.specialties.includes(specialty)) {
        continue;
      }

      // Buscar protocolos relevantes
      if (protocol.name.toLowerCase().includes(diagnosisLower) ||
          protocol.description.toLowerCase().includes(diagnosisLower) ||
          protocol.indications.some(ind => ind.toLowerCase().includes(diagnosisLower))) {
        relevantProtocols.push(protocol);
      }
    }

    return relevantProtocols;
  }

  /**
   * Obtener contraindicaciones para una tÃ©cnica
   */
  getContraindications(techniqueId: string, professionalProfileId: string): string[] {
    const knowledge = this.medicalKnowledge.get(techniqueId);
    const profile = this.profileService.getProfile(professionalProfileId);
    
    if (!knowledge || !profile) {
      return [];
    }

    // Verificar si el profesional tiene las certificaciones necesarias
    const hasRequiredCertifications = knowledge.certifications.length === 0 ||
      knowledge.certifications.some(cert => profile.certifications.includes(cert));

    if (!hasRequiredCertifications) {
      return ['CertificaciÃ³n requerida: ' + knowledge.certifications.join(', ')];
    }

    return knowledge.contraindications;
  }

  /**
   * Obtener referencias bibliogrÃ¡ficas
   */
  getReferences(knowledgeId: string): string[] {
    const knowledge = this.medicalKnowledge.get(knowledgeId);
    return knowledge?.references || [];
  }

  /**
   * Actualizar conocimiento
   */
  updateKnowledge(knowledgeId: string, updates: Partial<MedicalKnowledge>): boolean {
    const knowledge = this.medicalKnowledge.get(knowledgeId);
    if (!knowledge) {
      return false;
    }

    const updatedKnowledge: MedicalKnowledge = {
      ...knowledge,
      ...updates,
      lastUpdated: new Date()
    };

    this.medicalKnowledge.set(knowledgeId, updatedKnowledge);
    return true;
  }

  /**
   * Agregar nuevo conocimiento
   */
  addKnowledge(knowledge: Omit<MedicalKnowledge, 'id' | 'lastUpdated'>): string {
    const id = `kb-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    const newKnowledge: MedicalKnowledge = {
      ...knowledge,
      id,
      lastUpdated: new Date()
    };

    this.medicalKnowledge.set(id, newKnowledge);
    return id;
  }

  /**
   * Obtener estadÃ­sticas de la base de conocimiento
   */
  getKnowledgeStats(): {
    totalKnowledge: number;
    pathologies: number;
    techniques: number;
    tests: number;
    protocols: number;
    countries: string[];
  } {
    const knowledge = Array.from(this.medicalKnowledge.values());
    const countries = new Set<string>();
    
    knowledge.forEach(k => k.countries.forEach(c => countries.add(c)));

    return {
      totalKnowledge: knowledge.length,
      pathologies: knowledge.filter(k => k.category === 'pathology').length,
      techniques: knowledge.filter(k => k.category === 'technique').length,
      tests: this.diagnosticTests.size,
      protocols: this.clinicalProtocols.size,
      countries: Array.from(countries)
    };
  }
}

export default KnowledgeBaseService; 