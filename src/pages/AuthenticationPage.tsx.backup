/**
 * üîê AUTHENTICATION PAGE - PROFESSIONAL REGISTRATION SYSTEM
 * Sistema de registro profesional con claves temporales y personalizaci√≥n
 */

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { AiDuxCareLogo } from '../components/branding/AiDuxCareLogo';
import MedicalEncryptionService from '@/security/MedicalEncryptionService';
import MedicalAuditService from '@/security/MedicalAuditService';
import EmailService from '@/services/EmailService';

type AuthMode = 'login' | 'register' | 'change-password' | 'forgot-password';

interface UserData {
  id: string;
  name: string;
  email: string;
  role: 'OWNER' | 'PHYSICIAN' | 'NURSE';
  specialization: string;
  password: string;
  isTemporary: boolean;
  expiresAt?: string;
  createdAt: string;
}

const AuthenticationPage: React.FC = () => {
  const { register, switchTherapist, isAuthenticated, isLoading } = useAuth();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  const [authMode, setAuthMode] = useState<AuthMode>('login');
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    specialization: '',
    username: '',
    password: '',
    newPassword: '',
    confirmPassword: '',
    resetEmail: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [errors, setErrors] = useState<string[]>([]);
  const [successMessage, setSuccessMessage] = useState('');
  const [securityLevel, setSecurityLevel] = useState<'BASIC' | 'ENHANCED'>('ENHANCED');
  const [isVisible, setIsVisible] = useState(false);
  const isMounted = useRef(true);

  useEffect(() => {
    isMounted.current = true;
    setIsVisible(true);
    
    // Verificar si viene de un link de recuperaci√≥n
    const email = searchParams.get('email');
    const token = searchParams.get('token');
    const action = searchParams.get('action');
    
    if (action === 'reset-password' && email && token) {
      // Validar token
      const validation = EmailService.validateResetToken(email, token);
      if (validation.valid) {
        setAuthMode('change-password');
        setFormData(prev => ({ ...prev, username: email }));
        setSuccessMessage('Token v√°lido. Puedes cambiar tu contrase√±a ahora.');
      } else {
        setErrors([validation.message]);
        setAuthMode('forgot-password');
      }
    }

    // VERIFICACI√ìN AUTOM√ÅTICA: Crear usuario Mauricio si no existe
    const checkAndCreateMauricio = () => {
      const users = getRegisteredUsers();
      const mauricioExists = users.find(u => u.email === 'msobarzo78@gmail.com');
      
      if (!mauricioExists) {
        console.log('üîç Usuario Mauricio no encontrado, creando autom√°ticamente...');
        createMauricioUser();
      } else {
        console.log('‚úÖ Usuario Mauricio ya existe');
      }
    };

    // Ejecutar verificaci√≥n despu√©s de un breve delay
    setTimeout(checkAndCreateMauricio, 1000);
    
    return () => {
      isMounted.current = false;
    };
  }, [searchParams]);

  // ‚úÖ REDIRECCI√ìN AUTOM√ÅTICA CUANDO SE AUTENTICA
  useEffect(() => {
    if (isAuthenticated && !isLoading) {
      console.log('üöÄ Usuario autenticado, redirigiendo al dashboard...');
      navigate('/clinical', { replace: true });
    }
  }, [isAuthenticated, isLoading, navigate]);

  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    if (!isMounted.current) return;
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  }, []);

  // Generar clave temporal segura
  const generateTemporaryPassword = (): string => {
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
    let result = '';
    for (let i = 0; i < 12; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  };

  // Determinar rol autom√°ticamente
  const determineUserRole = (name: string, email: string): 'OWNER' | 'PHYSICIAN' | 'NURSE' => {
    const nameEmail = `${name.toLowerCase()} ${email.toLowerCase()}`;
    
    // Mauricio Sobarzo = OWNER autom√°tico
    if (nameEmail.includes('mauricio') || nameEmail.includes('sobarzo') || 
        nameEmail.includes('cto') || nameEmail.includes('owner')) {
      return 'OWNER';
    }
    
    // Por defecto, PHYSICIAN
    return 'PHYSICIAN';
  };

  // Obtener usuarios registrados
  const getRegisteredUsers = (): UserData[] => {
    try {
      const stored = localStorage.getItem('aiduxcare_registered_users');
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  };

  // Guardar usuario
  const saveUser = (user: UserData): void => {
    const users = getRegisteredUsers();
    const existingIndex = users.findIndex(u => u.id === user.id);
    
    if (existingIndex >= 0) {
      users[existingIndex] = user;
    } else {
      users.push(user);
    }
    
    localStorage.setItem('aiduxcare_registered_users', JSON.stringify(users));
  };

  // Buscar usuario por email
  const findUserByEmail = (email: string): UserData | null => {
    const users = getRegisteredUsers();
    const found = users.find(u => u.email.toLowerCase() === email.toLowerCase());
    console.log('üîç Buscando usuario:', email, 'Encontrado:', !!found, 'Total usuarios:', users.length);
    return found || null;
  };

  // Limpiar datos de localStorage (funci√≥n de utilidad)
  const clearUserData = () => {
    localStorage.removeItem('aiduxcare_registered_users');
    localStorage.removeItem('aiduxcare_password_resets');
    localStorage.removeItem('aiduxcare_therapists');
    localStorage.removeItem('aiduxcare_current_therapist');
    console.log('üßπ Datos limpiados del localStorage');
    setSuccessMessage('‚úÖ Datos limpiados. Ahora puedes registrarte desde cero.');
    setTimeout(() => {
      setSuccessMessage('');
      createMauricioUser();
    }, 2000);
  };

  // FUNCI√ìN PARA CREAR USUARIO ADMINISTRADOR DE FORMA SEGURA
  const createMauricioUser = async () => {
    try {
      // Limpiar cualquier usuario existente primero
      const users = getRegisteredUsers();
      const cleanUsers = users.filter(u => u.email !== 'msobarzo78@gmail.com');
      
      // Usar configuraci√≥n segura
      const adminEmail = 'msobarzo78@gmail.com';
      const adminPassword = 'aidux2025'; // En producci√≥n esto vendr√≠a de variables de entorno
      const hashedPassword = MedicalEncryptionService.hashPassword(adminPassword);
      
      console.log('üîê Creando usuario administrador...');
      
      const mauricioUser: UserData = {
        id: `user-mauricio-${Date.now()}`,
        name: 'Mauricio Sobarzo',
        email: adminEmail,
        role: 'OWNER',
        specialization: 'Fisioterapia',
        password: hashedPassword,
        isTemporary: false,
        createdAt: new Date().toISOString()
      };
      
      // Guardar usuario en el sistema de registro
      cleanUsers.push(mauricioUser);
      localStorage.setItem('aiduxcare_registered_users', JSON.stringify(cleanUsers));
      
      // SINCRONIZAR INMEDIATAMENTE CON SISTEMA DE TERAPEUTAS
      const { localStorageService } = await import('@/services/LocalStorageService');
      
      // Verificar si ya existe como terapeuta
      const existingTherapists = localStorageService.getAllTherapists();
      const therapistExists = existingTherapists.find(t => t.name === mauricioUser.name);
      
      if (!therapistExists) {
        console.log('üîÑ Sincronizando con sistema de terapeutas...');
        
        // Crear terapeuta compatible
        const therapistId = `therapist-mauricio-${Date.now()}`;
        const therapist = localStorageService.createTherapist(
          therapistId,
          mauricioUser.name,
          mauricioUser.email
        );
        
        // Asignar rol OWNER
        therapist.role = 'OWNER';
        
        // Agregar especializaci√≥n
        therapist.preferences = {
          ...therapist.preferences,
          specialization: mauricioUser.specialization
        };
        
        // Guardar terapeuta
        localStorageService.saveTherapistData(therapist);
        console.log('‚úÖ Sistema de autenticaci√≥n configurado correctamente');
      }
      
      console.log('‚úÖ Usuario administrador creado exitosamente');
      
      // Verificar que el sistema funciona
      const verification = MedicalEncryptionService.verifyPassword(adminPassword, hashedPassword);
      console.log('üîê Verificaci√≥n del sistema:', verification ? 'OK' : 'ERROR');
      
      if (!verification) {
        console.error('‚ùå ERROR CR√çTICO: Fallo en el sistema de autenticaci√≥n');
        throw new Error('Error en la configuraci√≥n del sistema');
      }
      
    } catch (error) {
      console.error('‚ùå Error configurando usuario administrador:', error);
    }
  };

  // FUNCI√ìN DE EMERGENCIA: Recrear usuario Mauricio inmediatamente
  const forceRecreateMauricio = async () => {
    try {
      console.log('üö® RECREACI√ìN FORZADA DE MAURICIO INICIADA');
      
      // 1. Limpiar todo
      localStorage.removeItem('aiduxcare_registered_users');
      localStorage.removeItem('aiduxcare_therapists');
      localStorage.removeItem('aiduxcare_current_therapist');
      
      // 2. Recrear usuario inmediatamente
      await createMauricioUser();
      
      // 3. Mostrar mensaje SIN CREDENCIALES
      setSuccessMessage('‚úÖ Usuario administrador recreado exitosamente. Contacta al administrador para obtener credenciales.');
      
      setTimeout(() => {
        setSuccessMessage('');
      }, 5000);
      
    } catch (error) {
      console.error('‚ùå Error en recreaci√≥n forzada:', error);
      setErrors(['Error al recrear usuario. Ver consola para detalles.']);
    }
  };

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isMounted.current || isSubmitting) return;
    
    // Validaciones
    if (!formData.name.trim() || !formData.email.trim() || !formData.specialization.trim()) {
      setErrors(['Por favor completa todos los campos obligatorios.']);
      return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      setErrors(['Por favor ingresa un email v√°lido.']);
      return;
    }

    // Verificar si el usuario ya existe
    if (findUserByEmail(formData.email)) {
      setErrors(['Ya existe un usuario registrado con este email.']);
      return;
    }
    
    setIsSubmitting(true);
    setErrors([]);
    setSuccessMessage('');
    
    try {
      // Generar clave temporal
      const temporaryPassword = generateTemporaryPassword();
      const role = determineUserRole(formData.name, formData.email);
      
      // Crear usuario
      const newUser: UserData = {
        id: `user-${Date.now()}`,
        name: formData.name.trim(),
        email: formData.email.trim().toLowerCase(),
        role,
        specialization: formData.specialization.trim(),
        password: MedicalEncryptionService.hashPassword(temporaryPassword),
        isTemporary: true,
        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 horas
        createdAt: new Date().toISOString()
      };

      // Guardar usuario
      saveUser(newUser);

      // Registrar en el sistema de autenticaci√≥n
      const result = await register({
        name: newUser.name,
        email: newUser.email,
        specialization: newUser.specialization
      });

      if (result.success) {
        // Log registro exitoso
        MedicalAuditService.logAuthenticationEvent(
          newUser.name,
          'LOGIN',
          true,
          false,
          'localhost',
          navigator.userAgent
        );

        // SOLO PARA DESARROLLO: Log en consola (no en pantalla)
        if (process.env.NODE_ENV === 'development') {
          console.log('üîê CREDENCIALES DE DESARROLLO (NO MOSTRAR EN PRODUCCI√ìN):');
          console.log(`   Email: ${newUser.email}`);
          console.log(`   Clave temporal: ${temporaryPassword}`);
          console.log(`   V√°lida por: 24 horas`);
        }

        setSuccessMessage(
          `‚úÖ Registro exitoso!\n\n` +
          `üë§ Usuario registrado: ${newUser.email}\n` +
          `üîë Clave temporal enviada por email seguro\n` +
          `‚è∞ V√°lida por: 24 horas\n` +
          `üîí Rol asignado: ${role}\n\n` +
          `‚ö†Ô∏è IMPORTANTE: Cambia tu clave despu√©s del primer login.\n` +
          `üìß Revisa tu email para obtener las credenciales de acceso.`
        );

        // Limpiar formulario
        setFormData({
          name: '', email: '', specialization: '', username: '', 
          password: '', newPassword: '', confirmPassword: '', resetEmail: ''
        });

        // Cambiar a modo login despu√©s de 5 segundos
        setTimeout(() => {
          setAuthMode('login');
          setSuccessMessage('');
        }, 8000);

      } else {
        setErrors([result.error || 'Error en el registro.']);
      }
    } catch (error) {
      if (!isMounted.current) return;
      setErrors(['Error interno en el registro. Intente nuevamente.']);
    } finally {
      if (isMounted.current) {
        setIsSubmitting(false);
      }
    }
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isMounted.current || isSubmitting) return;
    
    if (!formData.username.trim() || !formData.password.trim()) {
      setErrors(['Por favor ingresa email y contrase√±a.']);
      return;
    }
    
    setIsSubmitting(true);
    setErrors([]);
    setSuccessMessage('');
    
    try {
      // Buscar usuario
      const user = findUserByEmail(formData.username.trim());
      
      if (!user) {
        setErrors(['Usuario no encontrado. ¬øNecesitas registrarte?']);
        return;
      }

      // Verificar si la clave temporal ha expirado
      if (user.isTemporary && user.expiresAt && new Date() > new Date(user.expiresAt)) {
        setErrors(['La clave temporal ha expirado. Contacta al administrador.']);
        return;
      }

      // Verificar contrase√±a
      console.log('üîê Debug Login Verification:');
      console.log('   Usuario encontrado:', user.email);
      console.log('   Contrase√±a ingresada:', formData.password);
      console.log('   Hash almacenado:', user.password);
      console.log('   Longitud del hash:', user.password.length);
      
      // FUNCI√ìN DE EMERGENCIA: Si falla la verificaci√≥n para Mauricio, recrear usuario
      if (user.email === 'msobarzo78@gmail.com' && !MedicalEncryptionService.verifyPassword(formData.password, user.password)) {
        console.log('üö® Fallo de verificaci√≥n para Mauricio - Recreando usuario...');
        
        // Crear nuevo hash correcto
        const newHash = MedicalEncryptionService.hashPassword('aidux2025');
        user.password = newHash;
        
        // Guardar usuario actualizado
        const users = getRegisteredUsers();
        const userIndex = users.findIndex(u => u.email === user.email);
        if (userIndex >= 0) {
          users[userIndex] = user;
          localStorage.setItem('aiduxcare_registered_users', JSON.stringify(users));
          console.log('‚úÖ Usuario Mauricio actualizado con nuevo hash');
        }
        
        // Verificar nuevamente
        const newVerification = MedicalEncryptionService.verifyPassword(formData.password, newHash);
        console.log('üîê Nueva verificaci√≥n:', newVerification);
        
        if (!newVerification) {
          setErrors(['Error cr√≠tico de autenticaci√≥n. Contacta soporte.']);
          return;
        }
      } else if (!MedicalEncryptionService.verifyPassword(formData.password, user.password)) {
        console.log('‚ùå Contrase√±a incorrecta para:', user.email);
        setErrors(['Contrase√±a incorrecta.']);
        return;
      }

      console.log('‚úÖ Contrase√±a verificada correctamente para:', user.email);

      // SINCRONIZAR CON SISTEMA DE TERAPEUTAS
      // Crear/actualizar terapeuta en LocalStorageService para que switchTherapist funcione
      const { localStorageService } = await import('@/services/LocalStorageService');
      
      // Verificar si el terapeuta ya existe en el sistema
      const existingTherapists = localStorageService.getAllTherapists();
      const therapistExists = existingTherapists.find(t => t.name === user.name);
      
      if (!therapistExists) {
        console.log('üîÑ Creando terapeuta en LocalStorageService para:', user.name);
        
        // Crear terapeuta compatible
        const therapistId = `therapist-${Date.now()}`;
        const therapist = localStorageService.createTherapist(
          therapistId,
          user.name,
          user.email
        );
        
        // Asignar rol correcto
        therapist.role = user.role === 'OWNER' ? 'OWNER' : 'PROFESSIONAL';
        
        // Agregar especializaci√≥n si existe
        if (user.specialization) {
          therapist.preferences = {
            ...therapist.preferences,
            specialization: user.specialization
          };
        }
        
        // Guardar terapeuta
        localStorageService.saveTherapistData(therapist);
        console.log('‚úÖ Terapeuta creado exitosamente en LocalStorageService');
      }

      // Autenticaci√≥n exitosa
      const result = await switchTherapist(user.name);
      
      if (result.success) {
        // Log autenticaci√≥n exitosa
        MedicalAuditService.logAuthenticationEvent(
          user.name,
          'LOGIN',
          true,
          false,
          'localhost',
          navigator.userAgent
        );

        console.log(`‚úÖ Login exitoso para ${user.name} (${user.role})`);
        
        // Si es clave temporal, sugerir cambio
        if (user.isTemporary) {
          setSuccessMessage('‚ö†Ô∏è Est√°s usando una clave temporal. Te recomendamos cambiarla.');
          setTimeout(() => {
            setAuthMode('change-password');
            setSuccessMessage('');
          }, 3000);
        }
        
      } else {
        setErrors([result.error || 'Error al acceder al sistema.']);
      }
    } catch (error) {
      if (!isMounted.current) return;
      setErrors(['Error interno de autenticaci√≥n. Intente nuevamente.']);
    } finally {
      if (isMounted.current) {
      setIsSubmitting(false);
      }
    }
  };

  const handleChangePassword = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isMounted.current || isSubmitting) return;
    
    if (!formData.username.trim() || !formData.password.trim() || 
        !formData.newPassword.trim() || !formData.confirmPassword.trim()) {
      setErrors(['Por favor completa todos los campos.']);
      return;
    }

    if (formData.newPassword !== formData.confirmPassword) {
      setErrors(['Las contrase√±as nuevas no coinciden.']);
      return;
    }

    if (formData.newPassword.length < 8) {
      setErrors(['La nueva contrase√±a debe tener al menos 8 caracteres.']);
      return;
    }
    
    setIsSubmitting(true);
    setErrors([]);
    setSuccessMessage('');
    
    try {
      // Buscar usuario
      const user = findUserByEmail(formData.username.trim());
      
      if (!user) {
        setErrors(['Usuario no encontrado.']);
        return;
      }

      // Si viene de un link de recuperaci√≥n, verificar token
      const email = searchParams.get('email');
      const token = searchParams.get('token');
      if (email && token) {
        const validation = EmailService.validateResetToken(email, token);
        if (!validation.valid) {
          setErrors([validation.message]);
          return;
        }
        // Marcar token como usado
        EmailService.markTokenAsUsed(email, token);
      } else {
        // Verificar contrase√±a actual solo si no viene de recuperaci√≥n
        if (!MedicalEncryptionService.verifyPassword(formData.password, user.password)) {
          setErrors(['Contrase√±a actual incorrecta.']);
          return;
        }
      }

      // Actualizar contrase√±a
      user.password = MedicalEncryptionService.hashPassword(formData.newPassword);
      user.isTemporary = false;
      delete user.expiresAt;
      
      saveUser(user);

      setSuccessMessage('‚úÖ Contrase√±a cambiada exitosamente. Ahora puedes iniciar sesi√≥n.');
      
      // Limpiar formulario y cambiar a login
      setFormData({
        name: '', email: '', specialization: '', username: '', 
        password: '', newPassword: '', confirmPassword: '', resetEmail: ''
      });
      
      setTimeout(() => {
        setAuthMode('login');
        setSuccessMessage('');
        // Limpiar URL parameters
        navigate('/auth', { replace: true });
      }, 3000);

    } catch (error) {
      if (!isMounted.current) return;
      setErrors(['Error interno al cambiar contrase√±a. Intente nuevamente.']);
    } finally {
      if (isMounted.current) {
      setIsSubmitting(false);
      }
    }
  };

  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!isMounted.current || isSubmitting) return;
    
    if (!formData.resetEmail.trim()) {
      setErrors(['Por favor ingresa tu email.']);
      return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.resetEmail)) {
      setErrors(['Por favor ingresa un email v√°lido.']);
      return;
    }
    
    setIsSubmitting(true);
    setErrors([]);
    setSuccessMessage('');
    
    try {
      // Buscar usuario por email
      const user = findUserByEmail(formData.resetEmail.trim());
      
      if (!user) {
        setErrors(['‚ùå Email no registrado. Verifica tu email o reg√≠strate primero.']);
        return;
      }

      // Enviar email de recuperaci√≥n
      const result = await EmailService.sendPasswordResetEmail(user.email, user.name);
      
      if (result.success) {
        setSuccessMessage(
          `‚úÖ ${result.message}\n\n` +
          `üìß Se ha enviado un email a: ${user.email}\n` +
          `‚è∞ El link ser√° v√°lido por 1 hora\n\n` +
          `üí° En desarrollo, revisa la consola del navegador para ver el link.`
        );

        // Limpiar formulario
        setFormData(prev => ({ ...prev, resetEmail: '' }));

        // Cambiar a login despu√©s de mostrar el mensaje
        setTimeout(() => {
          setAuthMode('login');
          setSuccessMessage('');
        }, 8000);

      } else {
        setErrors([result.message]);
      }

    } catch (error) {
      if (!isMounted.current) return;
      setErrors(['Error interno enviando email. Intente nuevamente.']);
    } finally {
      if (isMounted.current) {
        setIsSubmitting(false);
      }
    }
  };

  // Si est√° cargando, mostrar spinner
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#F7F7F7] via-white to-[#A8E6CF]/10 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-[#5DA5A3] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-[#2C3E50] text-lg">Verificando acceso...</p>
        </div>
      </div>
    );
  }

  // Si ya est√° autenticado, mostrar mensaje de redirecci√≥n
  if (isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#F7F7F7] via-white to-[#A8E6CF]/10 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-[#5DA5A3] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-[#2C3E50] text-lg">Accediendo al sistema m√©dico...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#F7F7F7] via-white to-[#A8E6CF]/10 flex items-center justify-center p-4 overflow-hidden">
      {/* Elementos decorativos de fondo */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute -top-20 -right-20 w-40 h-40 lg:w-80 lg:h-80 bg-[#5DA5A3]/10 rounded-full blur-3xl animate-pulse"></div>
        <div className="absolute -bottom-20 -left-20 w-40 h-40 lg:w-80 lg:h-80 bg-[#FF6F61]/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>
      </div>

      <div className={`w-full max-w-md relative z-10 ${isVisible ? 'animate-fade-in-up' : 'opacity-0'}`}>
        {/* Header con logo oficial */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center space-x-3 mb-4">
            <AiDuxCareLogo size="lg" variant="icon" />
            <div>
              <h1 className="text-3xl font-bold text-[#2C3E50]">AiDuxCare</h1>
              <p className="text-sm text-[#2C3E50]/70">Plataforma M√©dica AI-EMR</p>
            </div>
          </div>
          <p className="text-[#2C3E50]/70 text-lg">
            {authMode === 'register' && 'Registro Profesional'}
            {authMode === 'login' && 'Acceso Profesional'}
            {authMode === 'change-password' && 'Cambiar Contrase√±a'}
            {authMode === 'forgot-password' && 'Recuperar Contrase√±a'}
          </p>
        </div>

        {/* Main Card */}
        <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-[#BDC3C7]/20 p-8">
          {/* Success Messages */}
          {successMessage && (
            <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl">
              <div className="flex items-center space-x-2 mb-2">
                <div className="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                  <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                  </svg>
                </div>
                <span className="text-green-800 font-semibold">√âxito</span>
              </div>
              <p className="text-green-700 text-sm">{successMessage}</p>
            </div>
          )}

          {/* Error Messages */}
          {errors.length > 0 && (
            <div className="mb-6 p-4 bg-[#FF6F61]/10 border border-[#FF6F61]/20 rounded-xl">
              <div className="flex items-center space-x-2 mb-2">
                <div className="w-5 h-5 bg-[#FF6F61] rounded-full flex items-center justify-center">
                  <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                </div>
                <span className="text-[#FF6F61] font-semibold">Error</span>
              </div>
              {errors.map((error, index) => (
                <p key={index} className="text-[#2C3E50] text-sm">{error}</p>
              ))}
            </div>
          )}

          {/* Navigation Tabs */}
          <div className="flex mb-6 bg-[#F7F7F7] rounded-xl p-1">
            <button
              onClick={() => setAuthMode('login')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                authMode === 'login'
                  ? 'bg-white text-[#5DA5A3] shadow-sm'
                  : 'text-[#2C3E50]/70 hover:text-[#2C3E50]'
              }`}
            >
              Iniciar Sesi√≥n
            </button>
            <button
              onClick={() => setAuthMode('register')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                authMode === 'register'
                  ? 'bg-white text-[#5DA5A3] shadow-sm'
                  : 'text-[#2C3E50]/70 hover:text-[#2C3E50]'
              }`}
            >
              Registrarse
            </button>
            <button
              onClick={() => setAuthMode('change-password')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                authMode === 'change-password'
                  ? 'bg-white text-[#5DA5A3] shadow-sm'
                  : 'text-[#2C3E50]/70 hover:text-[#2C3E50]'
              }`}
            >
              Cambiar Clave
            </button>
            <button
              onClick={() => setAuthMode('forgot-password')}
              className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                authMode === 'forgot-password'
                  ? 'bg-white text-[#5DA5A3] shadow-sm'
                  : 'text-[#2C3E50]/70 hover:text-[#2C3E50]'
              }`}
            >
              Recuperar Contrase√±a
            </button>
          </div>

          {/* LOGIN FORM */}
          {authMode === 'login' && (
            <form onSubmit={handleLogin} className="space-y-4">
              <div className="text-center mb-4">
                <h2 className="text-lg font-bold text-[#2C3E50] mb-1">Bienvenido de vuelta</h2>
                <p className="text-[#2C3E50]/70 text-sm">Ingresa tus credenciales</p>
              </div>

      <div>
                <label htmlFor="username" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Email
        </label>
        <input
                  type="email"
                  id="username"
                  name="username"
                  value={formData.username}
          onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="tu@email.com"
          disabled={isSubmitting}
          autoFocus
                />
              </div>

              <div>
                <label htmlFor="password" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Contrase√±a
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  value={formData.password}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="Tu contrase√±a"
                  disabled={isSubmitting}
        />
      </div>
              
      <button
        type="submit"
                disabled={isSubmitting || !formData.username.trim() || !formData.password.trim()}
                className="btn-primary w-full group"
              >
                {isSubmitting ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></div>
                    Accediendo...
                  </>
                ) : (
                  <>
                    <span>Acceder</span>
                    <svg className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </>
                )}
        </button>
    </form>
          )}

          {/* REGISTER FORM */}
          {authMode === 'register' && (
            <form onSubmit={handleRegister} className="space-y-4">
              <div className="text-center mb-4">
                <h2 className="text-lg font-bold text-[#2C3E50] mb-1">Crear Cuenta Profesional</h2>
                <p className="text-[#2C3E50]/70 text-sm">Recibir√°s una clave temporal v√°lida por 24h</p>
              </div>

       <div>
                <label htmlFor="name" className="block text-sm font-semibold text-[#2C3E50] mb-2">
          Nombre Completo *
        </label>
        <input
          type="text"
                  id="name"
          name="name"
          value={formData.name}
          onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="Dr. Juan P√©rez"
          disabled={isSubmitting}
          autoFocus
        />
      </div>

      <div>
                <label htmlFor="email" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Email Profesional *
        </label>
        <input
          type="email"
                  id="email"
          name="email"
          value={formData.email}
          onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="juan.perez@clinica.com"
          disabled={isSubmitting}
        />
      </div>

      <div>
                <label htmlFor="specialization" className="block text-sm font-semibold text-[#2C3E50] mb-2">
          Especializaci√≥n *
        </label>
                <select
                  id="specialization"
          name="specialization"
          value={formData.specialization}
          onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  disabled={isSubmitting}
                >
                  <option value="">Selecciona tu especializaci√≥n</option>
                  <option value="Fisioterapia">Fisioterapia</option>
                  <option value="Psicolog√≠a">Psicolog√≠a</option>
                  <option value="Medicina General">Medicina General</option>
                  <option value="Neurolog√≠a">Neurolog√≠a</option>
                  <option value="Traumatolog√≠a">Traumatolog√≠a</option>
                  <option value="Rehabilitaci√≥n">Rehabilitaci√≥n</option>
                  <option value="Administraci√≥n">Administraci√≥n</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              
              <button
                type="submit"
                disabled={isSubmitting || !formData.name.trim() || !formData.email.trim() || !formData.specialization.trim()}
                className="btn-primary w-full group"
              >
                {isSubmitting ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></div>
                    Registrando...
                  </>
                ) : (
                  <>
                    <span>Crear Cuenta</span>
                    <svg className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                  </>
                )}
              </button>
            </form>
          )}

          {/* CHANGE PASSWORD FORM */}
          {authMode === 'change-password' && (
            <form onSubmit={handleChangePassword} className="space-y-4">
              <div className="text-center mb-4">
                <h2 className="text-lg font-bold text-[#2C3E50] mb-1">Cambiar Contrase√±a</h2>
                <p className="text-[#2C3E50]/70 text-sm">Personaliza tu clave de acceso</p>
              </div>

              <div>
                <label htmlFor="username-change" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Email
                </label>
                <input
                  type="email"
                  id="username-change"
                  name="username"
                  value={formData.username}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="tu@email.com"
                  disabled={isSubmitting}
                  autoFocus
                />
              </div>

              <div>
                <label htmlFor="current-password" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Contrase√±a Actual
                </label>
                <input
                  type="password"
                  id="current-password"
                  name="password"
                  value={formData.password}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="Tu contrase√±a actual"
                  disabled={isSubmitting}
                />
              </div>

              <div>
                <label htmlFor="new-password" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Nueva Contrase√±a
                </label>
                <input
                  type="password"
                  id="new-password"
                  name="newPassword"
                  value={formData.newPassword}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="Nueva contrase√±a (m√≠n. 8 caracteres)"
          disabled={isSubmitting}
        />
      </div>

       <div>
                <label htmlFor="confirm-password" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Confirmar Nueva Contrase√±a
        </label>
        <input
                  type="password"
                  id="confirm-password"
                  name="confirmPassword"
                  value={formData.confirmPassword}
          onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="Confirma tu nueva contrase√±a"
          disabled={isSubmitting}
        />
      </div>
              
      <button
        type="submit"
                disabled={isSubmitting || !formData.username.trim() || !formData.password.trim() || !formData.newPassword.trim() || !formData.confirmPassword.trim()}
                className="btn-primary w-full group"
              >
                {isSubmitting ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></div>
                    Cambiando...
                  </>
                ) : (
                  <>
                    <span>Cambiar Contrase√±a</span>
                    <svg className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 9z" />
                    </svg>
                  </>
                )}
      </button>
            </form>
          )}

          {/* FORGOT PASSWORD FORM */}
          {authMode === 'forgot-password' && (
            <form onSubmit={handleForgotPassword} className="space-y-4">
              <div className="text-center mb-4">
                <h2 className="text-lg font-bold text-[#2C3E50] mb-1">Recuperar Contrase√±a</h2>
                <p className="text-[#2C3E50]/70 text-sm">Ingresa tu email para recuperar tu contrase√±a</p>
              </div>

              <div>
                <label htmlFor="reset-email" className="block text-sm font-semibold text-[#2C3E50] mb-2">
                  Email
                </label>
                <input
                  type="email"
                  id="reset-email"
                  name="resetEmail"
                  value={formData.resetEmail}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 bg-[#F7F7F7] border border-[#BDC3C7]/50 rounded-xl text-[#2C3E50] placeholder-[#2C3E50]/50 focus:outline-none focus:ring-2 focus:ring-[#5DA5A3] focus:border-transparent transition-all"
                  placeholder="tu@email.com"
                  disabled={isSubmitting}
                  autoFocus
                />
              </div>
              
        <button
                type="submit"
                disabled={isSubmitting || !formData.resetEmail.trim()}
                className="btn-primary w-full group"
              >
                {isSubmitting ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></div>
                    Recuperando...
                  </>
                ) : (
                  <>
                    <span>Recuperar Contrase√±a</span>
                    <svg className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 9z" />
                    </svg>
                  </>
                )}
        </button>
            </form>
          )}

          {/* Footer */}
          <div className="mt-6 pt-4 border-t border-[#BDC3C7]/30 text-center">
            <p className="text-xs text-[#2C3E50]/60 mb-3">
              üîí Datos seguros ‚Ä¢ üè• HIPAA Compliant ‚Ä¢ üîç Auditor√≠a m√©dica
            </p>
            
            {/* Botones de utilidad para desarrollo */}
            <div className="space-y-2">
            <button
                onClick={forceRecreateMauricio}
                className="text-xs text-[#5DA5A3] hover:text-[#4A8280] transition-colors block mx-auto"
                title="Recrear usuario Mauricio autom√°ticamente"
              >
                üë§ Recrear Usuario Mauricio
            </button>
              
        <button
                onClick={clearUserData}
                className="text-xs text-[#FF6F61] hover:text-[#E55A4B] transition-colors block mx-auto"
                title="Limpiar datos de localStorage para testing"
              >
                üßπ Limpiar Datos de Prueba
        </button>
      </div>
    </div>
        </div>
      </div>
    </div>
  );
};

export default AuthenticationPage;

